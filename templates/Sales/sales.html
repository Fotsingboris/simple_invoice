{% extends "base.html" %}
{% load static %}

{% block content %}

    <div class="content-wrapper">
        <div class="page-header">
            <h3 class="page-title">
                <span class="page-title-icon bg-gradient-primary text-white me-2">
                    <i class="mdi mdi-home"></i>
                </span> Create Invoice
            </h3>
            <nav aria-label="breadcrumb">
                <ul class="breadcrumb">
                    <li class="breadcrumb-item active" aria-current="page">
                        <span></span>Overview <i class="mdi mdi-alert-circle-outline icon-sm text-primary align-middle"></i>
                    </li>
                </ul>
            </nav>
        </div>

        <form method="post">
            {% csrf_token %}
            
            <!-- Invoice Info -->
            <div class="mb-3">
                <label for="invoice_number" class="form-label">Invoice Number</label>
                <input type="text" class="form-control" id="invoice_number" name="invoice_number" value="{{ invoice_number }}" readonly>
            </div>

            <div class="mb-3">
                <label for="date" class="form-label">Date</label>
                <input type="date" class="form-control" id="date" name="date" value="{{ date }}">
            </div>

            <!-- Products Table -->
            <h4>Products</h4>
            <table class="table" id="products_table">
                <thead>
                    <tr>
                        <th>Product Name</th>
                        <th>Quantity</th>
                        <th>Unit Price</th>
                        <th>Total Price</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="product-rows">
                    <tr class="product-row">
                        <td><input type="text" class="form-control" name="product_name[]" required></td>
                        <td><input type="number" class="form-control quantity" name="quantity[]" min="1" required></td>
                        <td><input type="number" class="form-control unit-price" name="unit_price[]" step="0.01" min="0" required></td>
                        <td><input type="text" class="form-control total-price" name="total_price[]" readonly></td>
                        <td><button type="button" class="btn btn-danger remove-row" disabled>&times;</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="btn btn-primary" id="add-row">Add Product</button>

            <div class="mt-4">
                <button type="submit" class="btn btn-success">Save Invoice</button>
            </div>
        </form>


        
        
       
    </div>

{% endblock %}

{% block scripts %} 
     
    <script>
        $(document).ready(function() {
            // Function to update the total price based on quantity and unit price
            function updateTotalPrice() {
                $('.product-row').each(function() {
                    const quantity = $(this).find('.quantity').val();
                    const unitPrice = $(this).find('.unit-price').val();
                    const totalPrice = (quantity && unitPrice) ? (quantity * unitPrice).toFixed(2) : 0;
                    $(this).find('.total-price').val(totalPrice);
                });
            }
    
            // Add new row
            $('#add-row').click(function() {
                const newRow = `<tr class="product-row">
                    <td><input type="text" class="form-control" name="product_name[]" required></td>
                    <td><input type="number" class="form-control quantity" name="quantity[]" min="1" required></td>
                    <td><input type="number" class="form-control unit-price" name="unit_price[]" step="0.01" min="0" required></td>
                    <td><input type="text" class="form-control total-price" name="total_price[]" readonly></td>
                    <td><button type="button" class="btn btn-danger remove-row">&times;</button></td>
                </tr>`;
                $('#product-rows').append(newRow);
                $('.remove-row').prop('disabled', false); // Enable the remove buttons once more than one row exists
            });
    
            // Remove row (at least one row must remain)
            $(document).on('click', '.remove-row', function() {
                if ($('.product-row').length > 1) {
                    $(this).closest('tr').remove();
                }
                if ($('.product-row').length === 1) {
                    $('.remove-row').prop('disabled', true); // Disable remove button if only one row is left
                }
                updateTotalPrice(); // Update total after row removal
            });
    
            // Update total price when quantity or unit price changes
            $(document).on('input', '.quantity, .unit-price', function() {
                updateTotalPrice();
            });
    
            // Initialize the first row's remove button to be disabled (since there should be at least one row)
            $('.remove-row').prop('disabled', true);
        });
    </script>
      {% endblock  %}
